---
title: "1.0_exploratory-analysis"
author: "Chike Odenigbo"
date: "2022-12-17"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
# install.packages('rstudioapi')
# install.packages("imputeTS")
# install.packages("naniar")
# install.packages("MissMech")
# install.packages('here')
# install.packages("glmnet")
# install.packages("splitstackshape")
# install.packages("mice")
#install.packages("randUnderClassif")
#library(randUnderClassif)
#install.packages("DMwR")
#remotes::install_version("DMwR", version="0.4.1")
#install.packages("imputation")
#install.packages("missForest")
#install.packages("DMwR2", dependencies=TRUE)
#install.packages("RANN")
#install_github("jmbh/randunderclassif")
#library(randUnderClassif)
#install.packages("Amelia")
#install.packages("Hmisc")
library(Amelia)
library(Hmisc)
library(RANN)
library(DMwR2) 
library(missForest)
library(mice)
library(glmnet)
library(here)
library("rstudioapi")
library(rstatix)
library(dplyr)
library(naniar)
library(imputeTS)
library(ggplot2)
library(car)
library(dplyr)
library(tidyr)
library(splitstackshape)
library(caret)
require(imputation)
```

## Import Data
```{r}
root_dir = dirname(here())
data = read.csv("./data/raw/CreditGame_TRAIN.csv")
row.names(data) = data$ID_TRAIN
credit.test = read.csv("./data/raw/CreditGame_Applications.csv",row.names="ID_TEST")

data = subset(data, select = -c(ID_TRAIN))
data$TYP_RES <- as.factor(data$TYP_RES)
data$ST_EMPL <- as.factor(data$ST_EMPL) #deal with nulls
data$DEFAULT <- as.factor(data$DEFAULT)



#attach(credit.train)
#data$ST_EMPL <- ifelse(data$ST_EMPL == "", "UNKNOWN", data$ST_EMPL)

# data = subset(data, select = -c(ID_TRAIN))
credit.test$TYP_RES <- as.factor(credit.test$TYP_RES)
credit.test$ST_EMPL <- as.factor(credit.test$ST_EMPL) #deal with nulls
#credit.test$DEFAULT <- as.factor(credit.test$DEFAULT)



#attach(credit.train)
#credit.test$ST_EMPL <- ifelse(credit.test$ST_EMPL == "", "UNKNOWN", credit.test$ST_EMPL)
```

## Feature Engineering

```{r}
#data$NB_MISSING_VALUES <- apply(data, 1, function(x) sum(is.na(x)))
#data$NB_MISSING_VALUES = 0
#data <- data %>%
#  mutate(NB_MISSING_VALUES = rowSums(is.null(.) | . == ""))

data <- data %>%
  mutate(NUM_NA = rowSums(is.na(data)))
data <- data %>%
  mutate(NUM_EMPTY_STRINGS = rowSums(data == ""))

data <- data %>%
  mutate(NUM_EMPTY_STRINGS = ifelse(is.na(NUM_EMPTY_STRINGS), 0, NUM_EMPTY_STRINGS))

data <- data %>%
  mutate(NUM_NA = ifelse(is.na(NUM_NA), 0, NUM_NA))

data$NB_MISSING_VALUES = data$NUM_EMPTY_STRINGS + data$NUM_NA

View(data[rowSums(is.na(data)) > 0,])

data$ST_EMPL <- ifelse(data$ST_EMPL == "", "UNKNOWN", data$ST_EMPL)
data$TAX = data$REV_BT - data$REV_NET
data$TAX_RATE = data$TAX/data$REV_BT
data$DEBT_ASSET_RATIO = data$MNT_PASS/data$MNT_ACT
data$DEBT_SAVINGS_RATIO = data$MNT_PASS/data$MNT_EPAR
data$CREDIT_UTILIZATION = data$MNT_UTIL_REN/data$MNT_AUT_REN

data$LOAN_PER_BORROWER = data$MNT_DEMANDE/data$NB_EMPT



data$LTV_RATIO = data$MNT_DEMANDE/data$MNT_ACT
data$SATI_TRANSACT_RATE = data$NB_SATI/data$NB_OPER
data$NB_ER_6MS_12MS = data$NB_ER_12MS - data$NB_ER_6MS
data$DELTA_NB_ER_6MS_12MS = data$NB_ER_6MS - data$NB_ER_6MS_12MS

data$PROFIT_IND = ifelse(data$PROFIT_LOSS>=0, 1, 0)

data <- data %>% 
    mutate_at(c('CREDIT_UTILIZATION'), ~replace_na(.,0))

data <- data %>% 
    mutate_at(c('DEBT_SAVINGS_RATIO'), ~replace_na(.,0))

data <- data %>% 
    mutate_at(c('SATI_TRANSACT_RATE'), ~replace_na(.,0))





#credit.test$NB_MISSING_VALUES <- apply(credit.test, 1, function(x) sum(is.na(x)))
#credit.test <- credit.test %>%
#  mutate(NB_MISSING_VALUES = rowSums(is.null(.) | . == ""))

credit.test <- credit.test %>%
  mutate(NUM_NA = rowSums(is.na(credit.test)))
credit.test <- credit.test %>%
  mutate(NUM_EMPTY_STRINGS = rowSums(credit.test == ""))

credit.test <- credit.test %>%
  mutate(NUM_EMPTY_STRINGS = ifelse(is.na(NUM_EMPTY_STRINGS), 0, NUM_EMPTY_STRINGS))

credit.test <- credit.test %>%
  mutate(NUM_NA = ifelse(is.na(NUM_NA), 0, NUM_NA))

credit.test$NB_MISSING_VALUES = credit.test$NUM_EMPTY_STRINGS + credit.test$NUM_NA

View(credit.test[rowSums(is.na(credit.test)) > 0,])

credit.test$ST_EMPL <- ifelse(credit.test$ST_EMPL == "", "UNKNOWN", credit.test$ST_EMPL)
credit.test$TAX = credit.test$REV_BT - credit.test$REV_NET
credit.test$TAX_RATE = credit.test$TAX/data$REV_BT
credit.test$DEBT_ASSET_RATIO = credit.test$MNT_PASS/credit.test$MNT_ACT
credit.test$DEBT_SAVINGS_RATIO = credit.test$MNT_PASS/credit.test$MNT_EPAR
credit.test$CREDIT_UTILIZATION = credit.test$MNT_UTIL_REN/credit.test$MNT_AUT_REN


credit.test$LOAN_PER_BORROWER = credit.test$MNT_DEMANDE/credit.test$NB_EMPT

credit.test$LTV_RATIO = credit.test$MNT_DEMANDE/data$MNT_ACT
credit.test$SATI_TRANSACT_RATE = credit.test$NB_SATI/credit.test$NB_OPER
credit.test$NB_ER_6MS_12MS = credit.test$NB_ER_12MS - credit.test$NB_ER_6MS
credit.test$DELTA_NB_ER_6MS_12MS = credit.test$NB_ER_6MS - credit.test$NB_ER_6MS_12MS
credit.test <- credit.test %>% 
    mutate_at(c('CREDIT_UTILIZATION'), ~replace_na(.,0))

credit.test <- credit.test %>% 
    mutate_at(c('DEBT_SAVINGS_RATIO'), ~replace_na(.,0))

credit.test <- credit.test %>% 
    mutate_at(c('SATI_TRANSACT_RATE'), ~replace_na(.,0))

#data$PROFIT_IND = ifelse(data$PROFIT_LOSS>=0, 1, 0)
#credit.train$NB_INTR_1_12M = credit.train$NB_INTR_1M - credit.train$NB_INTR_12M

#credit.train$DELTA_NB_INTR_1_12M = credit.train$NB_INTR_1M - credit.train$credit.train$NB_INTR_1_12M
#set.seed(42)  # good idea to set the random seed for reproducibility
#stratified(credit.train, c('DEFAULT'), 0.5)

#credit.train[order(credit.train$PROFIT_LOSS,decreasing = FALSE),]
set.seed(123)
train_index <- createDataPartition(data[,'DEFAULT'], p = 0.8, list = FALSE)
credit.train <- data[train_index, ]
credit.val <- data[-train_index, ]

data

```

```{r}
colnames(credit.train)[!complete.cases(t(credit.train))]
```
DROP THE PROFIT LOSS when training due to data leakage
```{r}
credit.train %>%
  group_by(PROFIT_IND) %>%
  summarise(count = n_distinct(DEFAULT))

sum(as.integer(credit.train$DEFAULT))
mean(as.integer(credit.test$DEFAULT), na.rm = TRUE)
mean(as.numeric(data$DEFAULT))
```

You can also embed plots, for example:

```{r}
FindOutliers <- function(data) {
  lowerq = quantile(data)[2]
  upperq = quantile(data)[4]
  iqr = upperq - lowerq #Or use IQR(data)
  # we identify extreme outliers
  extreme.threshold.upper = (iqr * 3) + upperq
  extreme.threshold.lower = lowerq - (iqr * 3)
  result <- which(data > extreme.threshold.upper | data < extreme.threshold.lower)
  length(result)
}
outlier.dist = data.frame(apply(na_mean(dplyr::select_if(credit.train, is.numeric)), 2, FindOutliers))
outlier.dist.df <- cbind(features = rownames(outlier.dist), outlier.dist)
rownames(outlier.dist.df) <- 1:nrow(outlier.dist.df)

colnames(outlier.dist.df) = c('features','nb_outliers')
outlier.dist.df[order(outlier.dist.df[,"nb_outliers"],decreasing = TRUE),]
```

## Calculate multicollinearity
#```{r}
model <- lm(DEFAULT ~ NB_ER_12MS + PRT_VAL + NB_ER_6MS + NB_DEC_12MS + NB_EMPT + NB_INTR_1M + NB_INTR_12M, data=credit.train)
vif(model)
vif(credit.train)#,'MNT_UTIL_REN')])
cor(dplyr::select_if(credit.train, is.numeric))
y = credit.train$DEFAULT
X = subset(na_mean(dplyr::select_if(credit.train, is.numeric)))
mod <- cv.glmnet(as.matrix(X),y ,family =   "binomial", alpha=1, nfolds=7)
#```

#```{r}
as.matrix(coef(mod, mod$lambda.min))
#```

```{r}
corr.pairs.all = cor(dplyr::select_if(na_mean(credit.train), is.numeric)) %>%
  as.data.frame() %>%
  mutate(var1 = rownames(.)) %>%
  gather(var2, value, -var1) %>%
  arrange(desc(value)) %>% 
  mutate_at(vars(value), funs(round(., 1)))
subset(corr.pairs.all, var1 != var2)

#colnames(credit.train)

```

```{r}
credit.train$SPLIT = 'TRAIN'
credit.val$SPLIT = 'VALIDATION'
credit.test$SPLIT = 'TEST'
credit.train$ID <- rownames(credit.train)
credit.val$ID <- rownames(credit.val)
credit.test$ID <- rownames(credit.test)

common_cols <- intersect(intersect(colnames(credit.train), colnames(credit.val)), colnames(credit.test))

# Select only the common columns from each data frame
df1_subset <- credit.test[, common_cols]
df2_subset <- credit.val[, common_cols]
df3_subset <- credit.train[, common_cols]

# Append the data frames by row, keeping only the common columns
credit.all <- bind_rows(df1_subset, df2_subset, df3_subset)
credit.all
```
```{r}
rm(data, df1_subset, df2_subset,df3_subset)
memory.size()
```

#```{r}
# Set the seed for reproducibility
set.seed(123)
#mice.options(cores = 4)
credit.all$SPLIT = factor(credit.all$SPLIT)
credit.all$ID = factor(credit.all$ID)
#credit.all$TYPE_FIN = factor(credit.all$TYPE_FIN)
credit.all$ST_EMPL = factor(credit.all$ST_EMPL)
# Run the mice function to impute the missing values in the train set
#imputer <- mice(credit.all,  method = "cart", m = 3, maxit = 100, printFlag = TRUE, seed = 123, meth = "fast")
imputer <- mice(credit.all,  method = "cart", seed = 123, maxit = 5, maxiter = 5, m = 1,parallel=TRUE)


credit.all.imputed = complete(imputer,"long", include=TRUE)

credit.train.imputed = credit.all %>% filter(SPLIT=='TRAIN')
credit.val.imputed = credit.all %>% filter(SPLIT=='VALIDATION')
credit.test.imputed = credit.all %>% filter(SPLIT=='TEST')

credit.train.imputed$DEFAULT = credit.train$DEFAULT
credit.train.imputed$PROFIT_LOSS = credit.train$PROFIT_LOSS

credit.val.imputed$DEFAULT = credit.val$DEFAULT
credit.val.imputed$PROFIT_LOSS = credit.val$PROFIT_LOSS
# Use the imputer object to impute the missing values in the test set
#credit <- mice::complete(x = imputer, data = as.matrix(credit.test))#, pred = TRUE)

#val_imputed <- complete(imputer, subset(credit.val, select = -c(PROFIT_LOSS, PROFIT_IND, DEFAULT)))

#```

#```{r}
# Impute missing values with Amelia
imputed_data <- amelia(subset(credit.all,select=-c(TYP_FIN)) , m.max = 5,idvars = c('ID','SPLIT'), noms = c('ST_EMPL','TYP_RES'),p2s=1)

# Print the imputed data
print(imputed_data$imputations[[1]])
#```


#```{r}
credit.val
#```
#```{r}
credit.val.imputed
#```

#```{r}
imputed_data <- knnImputation(credit.train,"AGE_D", scale = FALSE, k = 1)
imputed_data

imputer <- preProcess(subset(credit.train, select = -c(PROFIT_LOSS, PROFIT_IND, DEFAULT)), method = "knnImpute", k = 1)
predict(imputer, newdata = na_mean(credit.test))
#```

```{r}


credit.train.imputed = credit.all %>% filter(SPLIT=='TRAIN')
credit.val.imputed = credit.all %>% filter(SPLIT=='VALIDATION')
credit.test.imputed = credit.all %>% filter(SPLIT=='TEST')

credit.train.imputed <- credit.train.imputed %>%
  mutate(AGE_D_IMPUTED_RAND_SAMPLE = ifelse(is.na(AGE_D), sample(credit.train.imputed$AGE_D, 1), AGE_D))
credit.val.imputed <- credit.val.imputed %>%
  mutate(AGE_D_IMPUTED_RAND_SAMPLE = ifelse(is.na(AGE_D), sample(credit.train.imputed$AGE_D, 1), AGE_D))
credit.test.imputed <- credit.test.imputed %>%
  mutate(AGE_D_IMPUTED_RAND_SAMPLE = ifelse(is.na(AGE_D), sample(credit.train.imputed$AGE_D, 1), AGE_D))

credit.train.imputed$DEFAULT = credit.train$DEFAULT
credit.train.imputed$PROFIT_LOSS = credit.train$PROFIT_LOSS

credit.val.imputed$DEFAULT = credit.val$DEFAULT
credit.val.imputed$PROFIT_LOSS = credit.val$PROFIT_LOSS
# Use the imputer object to impute the missing values in the test set
#credit <- mice::complete(x = imputer, data = as.matrix(credit.test))#, pred = TRUE)

#val_imputed <- complete(imputer, subset(credit.val, select = -c(PROFIT_LOSS, PROFIT_IND, DEFAULT)))

#apply(credit.all, 1, function(x) any(is.na(x)))
#str(credit.all)
View(credit.all)


```
#```{r}
#credit.train$ST_EMPL = as.factor(credit.train$ST_EMPL)
#credit.train$TYP_FIN = as.factor(credit.train$TYP_FIN)
#credit.all = missForest(subset(credit.all,select=-c(TYP_FIN)), ntree = 10, parallel = "multicore")$ximp

# Set the seed for reproducibility
set.seed(123)
#mice.options(cores = 4)
credit.all$SPLIT = factor(credit.all$SPLIT)
#credit.all$ID = factor(credit.all$ID)
#credit.all$TYPE_FIN = factor(credit.all$TYPE_FIN)
credit.all$ST_EMPL = factor(credit.all$ST_EMPL)
#credit.all = missForest(subset(credit.all,select=-c(ID,TYP_FIN)), ntree = 10)$ximp

#credit.all = missForest(subset(credit.all,select=-c(ID,TYP_FIN)))$ximp

# Run the mice function to impute the missing values in the train set
#imputer <- mice(credit.all,  method = "cart", m = 3, maxit = 100, printFlag = TRUE, seed = 123, meth = "fast")
#imputer <- mice(credit.all,  method = "cart", seed = 123, maxit = 1, maxiter = 5, m = 1,parallel='multicores')
imputer <- mice(credit.all,  method = "pmm", seed = 123, maxit = 1, maxiter = 5, m = 1,parallel='multicores')


#credit.all.imputed = complete(imputer,"long", include=TRUE)
credit.all = complete(imputer,"long")


credit.train.imputed = credit.all %>% filter(SPLIT=='TRAIN')
credit.val.imputed = credit.all %>% filter(SPLIT=='VALIDATION')
credit.test.imputed = credit.all %>% filter(SPLIT=='TEST')

credit.train.imputed$DEFAULT = credit.train$DEFAULT
credit.train.imputed$PROFIT_LOSS = credit.train$PROFIT_LOSS

credit.val.imputed$DEFAULT = credit.val$DEFAULT
credit.val.imputed$PROFIT_LOSS = credit.val$PROFIT_LOSS
# Use the imputer object to impute the missing values in the test set
#credit <- mice::complete(x = imputer, data = as.matrix(credit.test))#, pred = TRUE)

#val_imputed <- complete(imputer, subset(credit.val, select = -c(PROFIT_LOSS, PROFIT_IND, DEFAULT)))

#apply(credit.all, 1, function(x) any(is.na(x)))
#str(credit.all)
View(credit.all)
imputer$loggedEvents
imputer$data
#```

```{r}
#balanced_data <- balance_data(data, ratio = "1:3")
default.class <- credit.train[credit.train$DEFAULT == 1, ]
no.default.class <- credit.train[credit.train$DEFAULT == 0, ]
n <- min(nrow(default.class), nrow(no.default.class)) # number of observations to select for each class
#credit.train.balanced <- rbind(sample(default.class, n), sample(no.default.class, n))
n
#sample_n(n,no.default.class,replace=FALSE)
credit.train.balanced <- rbind(default.class[sample(nrow(default.class), n), ], no.default.class[sample(nrow(no.default.class), n*2), ])
table(credit.train.balanced$DEFAULT)
default.class
```

```{r}
credit.train.imputed
```


```{r}
write.csv(credit.train.balanced, "data/processed/train_balanced.csv")
write.csv(credit.train.imputed, "data/processed/train_unbalanced.csv")
write.csv(credit.val.imputed, "data/processed/validation.csv")
write.csv(credit.test.imputed, "data/processed/test.csv")
write.csv(corr.pairs.all, "data/analysis/correlation.csv")
```


Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
